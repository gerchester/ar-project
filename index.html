<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR модель — быстрый тест</title>

  <!-- ЛОКАЛЬНО подключай свои библиотеки (убедись, что файлы доступны и без .txt) -->
  <script src="./aframe.min.js"></script>
  <script src="./mindar-image-aframe.prod.js"></script>

  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial;}
    .status{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:8px 12px;border-radius:12px;z-index:999}
    .hint{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:6px 10px;border-radius:10px;font-size:13px;z-index:999}
  </style>

  <script>
    // Компоненты регистрируем строго после того как AFRAME загружен
    (function waitForAframe(){
      if(!window.AFRAME){
        console.warn('AFRAME пока не загружен, жду 50ms...');
        return setTimeout(waitForAframe,50);
      }

      const THREE = AFRAME.THREE;
      // плавное следование по позиции/повороту (wrapper)
      AFRAME.registerComponent('smooth-transform', {
        schema: { lerpFactor: { type: 'number', default: 0.08 } }, // поиграйся: 0.05-0.2
        init: function () {
          const obj = this.el.object3D;
          this.smoothedPos = new THREE.Vector3().copy(obj.position);
          this.smoothedQuat = new THREE.Quaternion().copy(obj.quaternion);

          // при первом обнаружении маркера привязываем state чтобы не было скачка
          let target = this.el;
          while (target && !target.hasAttribute('mindar-image-target')) target = target.parentEl;
          if (target) {
            target.addEventListener('targetFound', () => {
              this.smoothedPos.copy(this.el.object3D.position);
              this.smoothedQuat.copy(this.el.object3D.quaternion);
            });
          }
        },
        tick: function () {
          const rawPos = this.el.object3D.position;
          const rawQuat = this.el.object3D.quaternion;
          this.smoothedPos.lerp(rawPos, this.data.lerpFactor);
          this.smoothedQuat.slerp(rawQuat, this.data.lerpFactor);
          this.el.object3D.position.copy(this.smoothedPos);
          this.el.object3D.quaternion.copy(this.smoothedQuat);
        }
      });

      // простая плавная ротация модели вокруг своей оси (не трогает позицию)
      AFRAME.registerComponent('smooth-rotation', {
        schema: { speed: { type: 'number', default: 0.006 } },
        tick: function (time, timeDelta) {
          this.el.object3D.rotation.y += this.data.speed * (timeDelta / 16);
        }
      });

      console.log('smooth-transform & smooth-rotation registered');
    })();
  </script>
</head>
<body>
  <div class="status" id="status">Старт — ждём камеру</div>
  <div class="hint">Наведи камеру на маркер (targetIndex: 0). Если модель не видна — проверь пути и консоль.</div>

  <a-scene id="scene"
    mindar-image="imageTargetSrc: ./targetsSTR.mind; uiLoading: no; uiScanning: no; uiError: no; autoStart: false;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <!-- Заменяй src на имя своей модели (в той же папке), или оставь своё -->
      <a-asset-item id="testModel" src="./model1_Lotok_gluhoy50.glb"></a-asset-item>
    </a-assets>

    <!-- простое освещение -->
    <a-light type="ambient" intensity="1.2"></a-light>
    <a-light type="directional" intensity="1.5" position="2 4 2"></a-light>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- единственный маркер + wrapper + модель -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-entity smooth-transform="lerpFactor: 0.08">
        <a-gltf-model id="theModel" src="#testModel"
                      position="0 0 0"
                      rotation="0 0 0"
                      scale="0.25 0.25 0.25"
                      smooth-rotation="speed:0.006">
        </a-gltf-model>
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    // логируем загрузку модели и контролируем AR старт
    (function(){
      const status = document.getElementById('status');
      const scene = document.querySelector('a-scene');
      const model = document.getElementById('theModel');

      if (model) {
        model.addEventListener('model-loaded', () => {
          console.log('MODEL LOADED OK');
          status.textContent = 'Модель загружена. Ждём камеру...';
        });
        model.addEventListener('model-error', (e) => {
          console.error('MODEL LOAD ERROR', e);
          status.textContent = 'Ошибка загрузки модели (см. консоль)';
        });
      }

      async function initAR(){
        try {
          status.textContent = 'Запрос камеры...';
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          stream.getTracks().forEach(t=>t.stop());
          startAR();
        } catch(err) {
          console.error('Camera permission error', err);
          status.textContent = 'Разреши доступ к камере';
        }
      }
      function startAR(){
        status.textContent = 'Запуск AR...';
        const arSystem = scene.systems['mindar-image-system'];
        scene.addEventListener('arReady', ()=> status.textContent = 'Point camera at marker');
        scene.addEventListener('arError', (ev)=> { console.error('AR error', ev); status.textContent='AR failed'; });
        arSystem.start();
      }

      // стартуем
      setTimeout(initAR, 400);
    })();
  </script>
</body>
</html>

























































